<?php
############################################################################
#       draw.class
#
#       Tim Traver
#       6/3/13
#       This is the draw Class for helping to manage the draw calculation process
#
############################################################################

class Draw {
	# Global class to handle event data and manipulation
	var $event_draw_id;
	var $event_id;
	var $draw=array();
	var $pilots=array();
	var $teams=array();
	var $rounds=array();
	
	function Draw($event_draw_id){
		# Initialization of the class
		$this->event_draw_id=$event_draw_id;
		$stmt=db_prep("
			SELECT *
			FROM event_draw
			WHERE event_draw_id=:event_draw_id
		");
		$result=db_exec($stmt,array("event_draw_id"=>$this->event_draw_id));
		$this->draw=$result[0];
		$this->event_id=$this->draw['event_id'];
		$this->get_pilots();
	}
	function get_pilots(){
		# Now lets get the pilots assigned to this event
		$stmt=db_prep("
			SELECT *
			FROM event_pilot ep
			LEFT JOIN pilot p ON ep.pilot_id=p.pilot_id
			WHERE ep.event_id=:event_id
				AND ep.event_pilot_status=1
		");
		$results=db_exec($stmt,array("event_id"=>$this->event_id));
		foreach($results as $pilot){
			$event_pilot_id=$pilot['event_pilot_id'];
			$team=$pilot['event_pilot_team'];
			$this->pilots[$event_pilot_id]=$pilot;
			$this->teams[$team][$event_pilot_id]=$pilot;
		}
		return;
	}
	function get_teams(){
		# Function to get the unique teams in an event
		$names=array();
		$stmt=db_prep("
			SELECT DISTINCT(ep.event_pilot_team)
			FROM event_pilot ep
			LEFT JOIN event e ON ep.event_id=e.event_id
			LEFT JOIN pilot p ON ep.pilot_id=p.pilot_id
			WHERE ep.event_pilot_team !=''
				AND e.event_id=:event_id
				AND ep.event_pilot_status=1
		");
		$names=db_exec($stmt,array("event_id"=>$this->event_id));
		$this->teams=$names;
		return;
	}
	function create_order_rounds(){
		# Function to create the round array for an order type of round
		# This means we essentially create the random array
		
		$round_from=$this->draw['event_draw_round_from'];
		$round_to=$this->draw['event_draw_round_to'];
		
		for($round=$round_from;$round<=$round_to;$round++){
			$ok=0;
			$last_team='';
			$order=array();
			$pilots=$this->pilots;
			shuffle($pilots);
			$loop=count($pilots);
			$total_pilots=count($pilots);
			for($x=1;$x<=$loop;$x++){
#				print "x=$x<br>\n";
				if(count($pilots)>1){
					$rand=mt_rand(0,$total_pilots);
#					print "rand=$rand<br>\n";
#					print "total_pilots=$total_pilots<br>\n";
#					print "size of pilots=".count($pilots)."<br>\n";
					$splice=array_splice($pilots,$rand-1,1);
					$order[]=$splice[0];
				}else{
					$order[]=$pilots[0];
				}
				$total_pilots--;
			}
#print_r($order);
			$x=1;
			foreach($order as $key=>$o){
				print "$x - {$o['pilot_first_name']} {$o['pilot_last_name']} - {$o['event_pilot_team']}<br>\n";
				$x++;
			}
			print "<br>";

		}
		
		
		return;
	}
	

}
?>